$NetBSD$

--- telnetd/telnetd.c.org	Tue Jul 31 00:01:12 2001
+++ telnetd/telnetd.c
@@ -1988,8 +1988,15 @@
 		return;
 	}
 #endif
-	(void) strcpy(nfrontp, "\r\n[Yes]\r\n");
-	nfrontp += 9;
+	/* Flush outstanding data if possible. If not, and buffers are
+	   full, break protocol and send no reply, rather than overflow
+	   the buffer.
+	 */
+	netflush();
+	if ( (BUFSIZ - (nfrontp - netobuf)) > 9 ) {
+		(void) strcpy(nfrontp, "\r\n[Yes]\r\n");
+		nfrontp += 9;
+	}
 }
 
 	void
